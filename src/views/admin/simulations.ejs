<div class="container py-5">
    <header class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-2">All Simulations</h1>
            </div>
            <a href="/" class="btn btn-outline-primary">New Simulation</a>
        </div>
    </header>

    <main>
        <% if (typeof error !== 'undefined' && error) { %>
        <div class="alert alert-danger" role="alert">
            <%= error %>
        </div>
        <% } %>

        <!-- Email Filter -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="GET" action="/admin/simulations" class="row g-3">
                    <% if (typeof pagination !== 'undefined' && pagination.limit) { %>
                    <input type="hidden" name="limit" value="<%= pagination.limit %>">
                    <% } %>
                    <% if (typeof filters !== 'undefined' && filters.sortBy && filters.sortBy !== 'createdAt') { %>
                    <input type="hidden" name="sortBy" value="<%= filters.sortBy %>">
                    <% } %>
                    <% if (typeof filters !== 'undefined' && filters.sortOrder && filters.sortOrder !== 'desc') { %>
                    <input type="hidden" name="sortOrder" value="<%= filters.sortOrder %>">
                    <% } %>
                    <div class="col-md-10">
                        <label for="email" class="form-label">Filter by Email</label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="email" 
                            name="email" 
                            placeholder="Enter email to search..."
                            value="<%= typeof filters !== 'undefined' && filters.email ? filters.email : '' %>"
                        >
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Search</button>
                    </div>
                    <% if (typeof filters !== 'undefined' && filters.email) { %>
                    <div class="col-12">
                        <a href="/admin/simulations<%= typeof pagination !== 'undefined' && pagination.limit ? '?limit=' + pagination.limit : '' %><%= typeof filters !== 'undefined' && filters.sortBy && filters.sortBy !== 'createdAt' ? '&sortBy=' + filters.sortBy : '' %><%= typeof filters !== 'undefined' && filters.sortOrder && filters.sortOrder !== 'desc' ? '&sortOrder=' + filters.sortOrder : '' %>" class="btn btn-sm btn-outline-secondary">Clear Filter</a>
                    </div>
                    <% } %>
                </form>
            </div>
        </div>

        <% if (simulations && simulations.length > 0) { %>
        <div class="card">
            <div class="card-header bg-light">
                <div class="row align-items-center">
                    <div class="col">
                        <strong>Total Simulations:</strong> <%= pagination.total %>
                    </div>
                    <div class="col-auto">
                        <span class="text-muted">Page <%= pagination.currentPage %> of <%= pagination.totalPages %></span>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">
                                    <a href="?sortBy=createdAt&sortOrder=<%= typeof filters !== 'undefined' && filters.sortBy === 'createdAt' && filters.sortOrder === 'asc' ? 'desc' : 'asc' %><%= typeof filters !== 'undefined' && filters.email ? '&email=' + encodeURIComponent(filters.email) : '' %>" class="text-decoration-none text-dark">
                                        Date
                                        <% if (typeof filters !== 'undefined' && filters.sortBy === 'createdAt') { %>
                                            <span class="text-muted"><%= filters.sortOrder === 'asc' ? '↑' : '↓' %></span>
                                        <% } %>
                                    </a>
                                </th>
                                <th scope="col">
                                    <a href="?sortBy=email&sortOrder=<%= typeof filters !== 'undefined' && filters.sortBy === 'email' && filters.sortOrder === 'asc' ? 'desc' : 'asc' %><%= typeof filters !== 'undefined' && filters.email ? '&email=' + encodeURIComponent(filters.email) : '' %>" class="text-decoration-none text-dark">
                                        Email
                                        <% if (typeof filters !== 'undefined' && filters.sortBy === 'email') { %>
                                            <span class="text-muted"><%= filters.sortOrder === 'asc' ? '↑' : '↓' %></span>
                                        <% } %>
                                    </a>
                                </th>
                                <th scope="col" class="text-end">
                                    <a href="?sortBy=purchasePrice&sortOrder=<%= typeof filters !== 'undefined' && filters.sortBy === 'purchasePrice' && filters.sortOrder === 'asc' ? 'desc' : 'asc' %><%= typeof filters !== 'undefined' && filters.email ? '&email=' + encodeURIComponent(filters.email) : '' %>" class="text-decoration-none text-dark">
                                        Purchase Price
                                        <% if (typeof filters !== 'undefined' && filters.sortBy === 'purchasePrice') { %>
                                            <span class="text-muted"><%= filters.sortOrder === 'asc' ? '↑' : '↓' %></span>
                                        <% } %>
                                    </a>
                                </th>
                                <th scope="col" class="text-end">
                                    <a href="?sortBy=monthlyRent&sortOrder=<%= typeof filters !== 'undefined' && filters.sortBy === 'monthlyRent' && filters.sortOrder === 'asc' ? 'desc' : 'asc' %><%= typeof filters !== 'undefined' && filters.email ? '&email=' + encodeURIComponent(filters.email) : '' %>" class="text-decoration-none text-dark">
                                        Monthly Rent
                                        <% if (typeof filters !== 'undefined' && filters.sortBy === 'monthlyRent') { %>
                                            <span class="text-muted"><%= filters.sortOrder === 'asc' ? '↑' : '↓' %></span>
                                        <% } %>
                                    </a>
                                </th>
                                <th scope="col" class="text-end">
                                    <a href="?sortBy=annualFee&sortOrder=<%= typeof filters !== 'undefined' && filters.sortBy === 'annualFee' && filters.sortOrder === 'asc' ? 'desc' : 'asc' %><%= typeof filters !== 'undefined' && filters.email ? '&email=' + encodeURIComponent(filters.email) : '' %>" class="text-decoration-none text-dark">
                                        Annual Fee
                                        <% if (typeof filters !== 'undefined' && filters.sortBy === 'annualFee') { %>
                                            <span class="text-muted"><%= filters.sortOrder === 'asc' ? '↑' : '↓' %></span>
                                        <% } %>
                                    </a>
                                </th>
                                <th scope="col" class="text-end">Year 1 ROI</th>
                                <th scope="col" class="text-end">Year 2 ROI</th>
                                <th scope="col" class="text-end">Year 3 ROI</th>
                                <th scope="col" class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% simulations.forEach((sim) => { %>
                            <tr>
                                <td>
                                    <%= typeof formatDate !== 'undefined' ? formatDate(sim.createdAt, locale) : new Date(sim.createdAt).toLocaleString(locale || 'en-US') %>
                                </td>
                                <td><%= sim.email %></td>
                                <td class="text-end"><%= typeof formatCurrency !== 'undefined' ? formatCurrency(sim.purchasePrice, locale, currency) : '€' + sim.purchasePrice.toLocaleString(locale || 'en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                                <td class="text-end"><%= typeof formatCurrency !== 'undefined' ? formatCurrency(sim.monthlyRent, locale, currency) : '€' + sim.monthlyRent.toLocaleString(locale || 'en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                                <td class="text-end"><%= typeof formatCurrency !== 'undefined' ? formatCurrency(sim.annualFee, locale, currency) : '€' + sim.annualFee.toLocaleString(locale || 'en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                                <td class="text-end">
                                    <span class="badge bg-success">
                                        <%= sim.results[0] ? sim.results[0].roi.toFixed(2) + '%' : 'N/A' %>
                                    </span>
                                </td>
                                <td class="text-end">
                                    <span class="badge bg-info">
                                        <%= sim.results[1] ? sim.results[1].roi.toFixed(2) + '%' : 'N/A' %>
                                    </span>
                                </td>
                                <td class="text-end">
                                    <span class="badge bg-primary">
                                        <%= sim.results[2] ? sim.results[2].roi.toFixed(2) + '%' : 'N/A' %>
                                    </span>
                                </td>
                                <td class="text-center">
                                    <a href="/admin/simulations/<%= sim._id %>" class="btn btn-sm btn-outline-primary">
                                        View Details
                                    </a>
                                </td>
                            </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            </div>
            <% if (pagination.totalPages > 1) { %>
            <div class="card-footer">
                <nav aria-label="Simulations pagination">
                    <% 
                    // Build query string for pagination links
                    const queryParams = [];
                    if (typeof filters !== 'undefined' && filters.email) {
                        queryParams.push('email=' + encodeURIComponent(filters.email));
                    }
                    if (typeof filters !== 'undefined' && filters.sortBy && filters.sortBy !== 'createdAt') {
                        queryParams.push('sortBy=' + filters.sortBy);
                    }
                    if (typeof filters !== 'undefined' && filters.sortOrder && filters.sortOrder !== 'desc') {
                        queryParams.push('sortOrder=' + filters.sortOrder);
                    }
                    const queryString = queryParams.length > 0 ? '&' + queryParams.join('&') : '';
                    %>
                    <ul class="pagination justify-content-center mb-0">
                        <% if (pagination.hasPrev) { %>
                        <li class="page-item">
                            <a class="page-link" href="?page=<%= pagination.currentPage - 1 %>&limit=<%= pagination.limit %><%= queryString %>">Previous</a>
                        </li>
                        <% } else { %>
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                        <% } %>

                        <% 
                        // Smart pagination: show first, last, current, and 2 pages around current
                        const current = pagination.currentPage;
                        const total = pagination.totalPages;
                        const pagesToShow = new Set();
                        
                        // Always show first and last
                        pagesToShow.add(1);
                        pagesToShow.add(total);
                        
                        // Show current and 2 pages around it
                        for (let i = Math.max(1, current - 2); i <= Math.min(total, current + 2); i++) {
                            pagesToShow.add(i);
                        }
                        
                        const sortedPages = Array.from(pagesToShow).sort((a, b) => a - b);
                        let lastPage = 0;
                        %>
                        <% sortedPages.forEach((pageNum) => { %>
                            <% if (pageNum - lastPage > 1) { %>
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                            <% } %>
                            <% if (pageNum === pagination.currentPage) { %>
                            <li class="page-item active">
                                <span class="page-link"><%= pageNum %></span>
                            </li>
                            <% } else { %>
                            <li class="page-item">
                                <a class="page-link" href="?page=<%= pageNum %>&limit=<%= pagination.limit %><%= queryString %>"><%= pageNum %></a>
                            </li>
                            <% } %>
                            <% lastPage = pageNum; %>
                        <% }); %>

                        <% if (pagination.hasNext) { %>
                        <li class="page-item">
                            <a class="page-link" href="?page=<%= pagination.currentPage + 1 %>&limit=<%= pagination.limit %><%= queryString %>">Next</a>
                        </li>
                        <% } else { %>
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                        <% } %>
                    </ul>
                </nav>
            </div>
            <% } %>
        </div>
        <% } else { %>
        <div class="alert alert-info" role="alert">
            <h5 class="alert-heading">No simulations found</h5>
            <p class="mb-0">There are no simulations in the database yet. <a href="/" class="alert-link">Create the first simulation</a>.</p>
        </div>
        <% } %>
    </main>
</div>

